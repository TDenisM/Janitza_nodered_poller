"use strict";module.exports=function(a){require("source-map-support").install();var i=require("./modbus-basics"),t=require("./core/modbus-core"),s=require("debug")("contribModbus:flex:write");a.nodes.registerType("modbus-flex-write",function(e){a.nodes.createNode(this,e),this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.emptyMsgOnFail=e.emptyMsgOnFail,this.keepMsgProperties=e.keepMsgProperties,this.internalDebugLog=s,this.verboseLogging=a.settings.verbose;var o=this;o.bufferMessageList=new Map,i.setNodeStatusTo("waiting",o);var r=a.nodes.getNode(e.server);r&&(r.registerForModbus(o),i.initModbusClientEvents(o,r),o.onModbusWriteDone=function(e,a){o.showStatusActivities&&i.setNodeStatusTo("writing done",o),o.send(t.buildMessage(o.bufferMessageList,a.payload,e,a)),o.emit("modbusFlexWriteNodeDone")},o.errorProtocolMsg=function(e,a){i.logMsgError(o,e,a),i.sendEmptyMsgOnFail(o,e,a)},o.onModbusWriteError=function(e,a){o.internalDebugLog(e.message);a=t.getOriginalMessage(o.bufferMessageList,a);o.errorProtocolMsg(e,a),i.setModbusError(o,r,e,a),o.emit("modbusFlexWriteNodeError")},o.prepareMsg=function(e){return"string"==typeof e.payload&&(e.payload=JSON.parse(e.payload)),e.payload.fc=parseInt(e.payload.fc),e.payload.unitid=parseInt(e.payload.unitid),e.payload.address=parseInt(e.payload.address),e.payload.quantity=parseInt(e.payload.quantity),e},o.isValidModbusMsg=function(e){var a=!0;return Number.isInteger(e.payload.fc)&&(5===e.payload.fc||6===e.payload.fc||15===e.payload.fc||16===e.payload.fc)||(o.error("FC Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.address)&&0<=e.payload.address&&e.payload.address<=65535||(o.error("Address Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.quantity)&&1<=e.payload.quantity&&e.payload.quantity<=65535||(o.error("Quantity Not Valid",e),a&=!1),a},o.setMsgPayloadFromHTTPRequests=function(e){return Object.prototype.hasOwnProperty.call(e.payload,"value")&&"string"==typeof e.payload.value&&("true"===e.payload.value||"false"===e.payload.value?e.payload.value="true"===e.payload.value:-1<e.payload.value.indexOf(",")&&(e.payload.value=JSON.parse(e.payload.value))),e},o.buildNewMessageObject=function(e,a){var s=t.getObjectId();return{topic:a.topic||e.id,messageId:s,payload:{value:Object.prototype.hasOwnProperty.call(a.payload,"value")?a.payload.value:a.payload,unitid:a.payload.unitid,fc:a.payload.fc,address:a.payload.address,quantity:a.payload.quantity,messageId:s}}},o.on("input",function(a){if(!i.invalidPayloadIn(a)&&r.client){a=Object.assign({},a);try{var e,s,t=o.prepareMsg(a);o.isValidModbusMsg(t)&&(e=o.setMsgPayloadFromHTTPRequests(t),s=o.buildNewMessageObject(o,e),o.bufferMessageList.set(s.messageId,i.buildNewMessage(o.keepMsgProperties,e,s)),r.emit("writeModbus",s,o.onModbusWriteDone,o.onModbusWriteError))}catch(e){o.errorProtocolMsg(e,a)}o.showStatusActivities&&i.setNodeStatusTo(r.actualServiceState,o)}}),o.on("close",function(e){i.setNodeStatusTo("closed",o),o.bufferMessageList.clear(),r.deregisterForModbus(o.id,e)}),o.showStatusActivities||i.setNodeDefaultStatus(o))})};
//# sourceMappingURL=maps/modbus-flex-write.js.map
